<?php
defined('BASEPATH') OR exit('No direct script access allowed');
require('base.php');

class opentest extends base{
	public function __construct()
	{
		parent::__construct();
		$this->load->model('user_model');
		$this->load->model('school_model');
	}
	//测试openid
	public function index(){
		$openid=$this->input->get('openid');
		if(empty($openid)){
			$data=$this->httpCode(611,'openid为空','');
		}else{
			$_SESSION['openid']=$openid;          
			$arr=$this->user_model->userinfo($openid);
			if(!empty($arr)){
				$schoolid=$arr['schoolid'];
				$wip=$this->school_model->getschoolwip($schoolid);
				//把常用值写入SESSION
				$_SESSION['userid']=$arr['userid'];
				$_SESSION['schoolid']=$arr['schoolid'];
				$_SESSION['wip']=$wip['wip'];
				$_SESSION['roleid']=$arr['roleid'];
				if($arr['roleid']==4 || $arr['roleid']==6){
					$studentid=$arr['userid'];
					$schoolid=$arr['schoolid'];
					$sql="select classid from student_sign  where  schoolid=$schoolid and class_status=1 and studentid like  '%,".$studentid.",%'  order by id desc";
					$ree=$this->db->query($sql)->row_array();
					if($ree){
						$_SESSION['classid']=$ree['classid'];
					}else{
						//取默认classid
						$_SESSION['classid']=79;		//测试使用
					}
				}			
				//直接跳转到‘我的课程’页面
				header("location:/wap/htmlv/course/myCourse.html");
			}else{
				//跳转至登录准备页面
				//$_SESSION['classid']=40;	//测试使用
				header("location:/wap/htmlv/user/guide.html");
			}	
		}
		echo json_encode($data);
	}
}